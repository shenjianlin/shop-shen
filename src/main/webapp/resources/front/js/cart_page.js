Sy.ns("Sy.shop.cart");(function(s){var p,o,a;function j(){var y=true;a.each(function(){if(!$(this).prop("checked")&&!$(this).prop("disabled")){y=false;return false}});o.attr("checked",y);p.each(function(){var z=true;var B=$(this).attr("code");var A=$(".merchantItems_"+B).find("input[name='ids']");A.each(function(){if(!$(this).prop("checked")&&!$(this).prop("disabled")){z=false;return false}});$(this).attr("checked",z)})}function e(){o.click(function(){if(a.length==0){return false}var z=$(this).prop("checked");a.each(function(){if(!$(this).prop("disabled")){$(this).attr("checked",z)}});p.each(function(){if(!$(this).prop("disabled")){$(this).attr("checked",z)}});o.attr("checked",z);var y;clearTimeout(y);if(z){var A=$("#cartId").val();y=setTimeout(function(){$.ajax({url:"checkedAll.jhtml",type:"POST",data:{cartId:A},dataType:"json",cache:false,async:false,success:function(B){}})},500)}else{var A=$("#cartId").val();y=setTimeout(function(){$.ajax({url:"nocheckedAll.jhtml",type:"POST",data:{cartId:A},dataType:"json",cache:false,async:false,success:function(B){}})},500)}j();n();l()})}function x(){p.click(function(){var A=$(this).prop("checked");var C=$(this).attr("code");var B=$(".merchantItems_"+C).find("input[name='ids']");B.each(function(){if(!$(this).prop("disabled")){$(this).attr("checked",A)}});var y=$(".merchantItems_"+C).find("input[name='cartItemId']");var z;clearTimeout(z);if(A){z=setTimeout(function(){$.ajax({url:"checkedMerchant.jhtml",type:"POST",data:y.serialize(),dataType:"json",cache:false,async:false,success:function(D){}})},500)}else{z=setTimeout(function(){$.ajax({url:"nocheckedMerchant.jhtml",type:"POST",data:y.serialize(),dataType:"json",cache:false,async:false,success:function(D){}})},500)}j();n();l()})}function c(){a.click(function(){var y=$(this).parents(".cart-list");var A=y.find("input[name='cartItemId']").val();var z;clearTimeout(z);if($(this).prop("checked")){z=setTimeout(function(){$.ajax({url:"checked.jhtml",type:"POST",data:{cartItemId:A},dataType:"json",cache:false,async:false,success:function(B){}})},500)}else{z=setTimeout(function(){$.ajax({url:"nochecked.jhtml",type:"POST",data:{cartItemId:A},dataType:"json",cache:false,async:false,success:function(B){}})},500)}j();n();l()})}function k(B){var z={};var C=parseInt(B.val());var A=B.parents(".cart-list");var y=parseInt(A.find("input[name='realStock']").val());if(C>=y){C=y;B.val(C)}if(C==y||y<5){A.find(".realStock").show()}else{A.find(".realStock").hide()}var D=A.find("input[name='cartItemId']").val();clearTimeout(z[D]);z[D]=setTimeout(function(){$.ajax({url:"edit.jhtml",type:"POST",data:{cartItemId:D,quantity:C},dataType:"json",cache:false,success:function(E){if(E.message.type=="success"){A.find(".productAmount").html("￥"+E.productAmount);A.find("input[name='productAmount']").val(E.productAmount);A.find("input[name='productDiscount']").val(E.productDiscount);if(E.weightAmount){A.find(".weightAmount").html("（"+E.weightAmount+"kg）");A.find("input[name='weightAmount']").val(E.weightAmount)}if(!E.isStockEnough||E.isStockWarn){A.find(".realStock").html("库存仅剩"+E.realStock)}n();l()}else{showMessageDiv(E.message.type,E.message.content);setTimeout(function(){location.reload(true)},3000)}}})},500)}function r(){var A=$("input.btn_jian");A.click(function(){var B=$(this).next();var C=$.trim(B.val());if(/^\d*[1-9]\d*$/.test(C)&&parseInt(C)>1){B.val(parseInt(C)-1)}else{B.val(1)}k(B)});var z=$("input.btn_jia");z.click(function(){var B=$(this).prev();var C=$.trim(B.val());if(/^\d*[1-9]\d*$/.test(C)){B.val(parseInt(C)+1)}else{B.val(1)}k(B)});var y=$("input.input_jiajian");y.keypress(function(C){var B=C.keyCode?C.keyCode:C.which;if((B>=48&&B<=57)||B==8){return true}else{return false}});y.blur(function(){var B=$(this);var C=$.trim(B.val());if(parseInt(C)<1){B.val(1)}else{B.val(C)}k(B)})}function q(){$("a.cleanSelect").click(function(){$.messager.confirm("我的购物车","您确定要将购物车清空吗？",function(y){if(y){var z=$("#cartId").val();$.ajax({url:"clearCart.jhtml",type:"POST",data:{cartId:z},dataType:"json",cache:false,success:function(A){if(A.type=="success"){window.location.href="/cart/list.jhtml"}else{showMessageDiv(A.type,A.content)}}})}})})}function g(){$("a.cleanInvalid").click(function(){$.messager.confirm("我的购物车","您确定要将清空已不能购买的商品项吗？",function(y){if(y){var z=$("#cartId").val();$.ajax({url:"cleanInvalid.jhtml",type:"POST",data:{cartId:z},dataType:"json",cache:false,success:function(A){if(A.type=="success"){window.location.href="/cart/list.jhtml"}else{showMessageDiv(A.type,A.content)}}})}})})}function d(){$("a.deleteSelect").click(function(){var y=$("input[name='ids']:enabled:checked");if(y.length<=0){showMessageDiv("warn","请选择要删除的购物车项");return false}var z="";y.each(function(A){if(A==0){z+=$(this).val()}else{z+=","+$(this).val()}});$.messager.confirm("我的购物车","您确定要将所选商品，移除购物车吗？",function(A){if(A){var B=$("#cartId").val();$.ajax({url:"deleteSelect.jhtml",type:"POST",data:{cartId:B,idsStr:z},dataType:"json",cache:false,success:function(C){if(C.type=="success"){window.location.href=shopxx.base+"/cart/list.jhtml"}else{showMessageDiv(C.type,C.content)}}})}})})}function f(){$("a.cart_del").click(function(){var z=$(this).parents(".cart-list");var A=z.find("input[name='cartItemId']").val();var y=z.find(".item_name a").text();$.messager.confirm("我的购物车","您确定要将商品 ["+y+"] ,移除购物车吗？",function(B){if(B){var C=$("#cartId").val();$.ajax({url:"delete.jhtml",type:"POST",data:{cartId:C,cartItemId:A},dataType:"json",cache:false,success:function(D){if(D.type=="success"){window.location.href=shopxx.base+"/cart/list.jhtml"}else{showMessageDiv(D.type,D.content)}}})}})});$("a.cart_clocn").click(function(){var y=$(this).parents(".cart-list");var z=y.find("input[name='productId']").val();addFavorite(z,shopxx.base,"/cart/list.jhtml")})}function l(){p.each(function(){var z=0;var B=0;var y=0;var D=$(this).attr("code");var C=$(".merchantItems_"+D).find("input[name='ids']:checked");C.each(function(){var E=$(this).parents(".cart-list");z++;if(E.find("input[name='weightAmount']").length>0){y+=parseFloat(E.find("input[name='weightAmount']").val())}B+=parseFloat(E.find("input[name='productAmount']").val())});$(".merchantItems_"+D).find("#merchantSelectCount i").html(z);$(".merchantItems_"+D).find("#merchantTotalWeight i").html(y.toFixed(3));var A=$(".merchantItems_"+D).find(".order-ems-tips");if(B>0){$.ajax({url:"showCartItemFreeFreigh.jhtml",type:"POST",data:{merchantCode:D,orderWeight:y,orderPrice:B},dataType:"json",cache:false,success:function(E){if(E!=""){if(E.description!=""){if(E.numerical>0){A.find("a").show()}else{A.find("a").hide()}A.find("b").text(E.description);A.show()}else{A.hide()}}else{A.hide()}}})}else{A.hide()}})}function n(){var B=0;var A=0;var y=0;var z=0;$("input[name='ids']:checked").each(function(){var D=$(this).parents(".cart-list");B+=parseFloat(D.find("input[name='productAmount']").val());z+=parseFloat(D.find("input[name='productDiscount']").val());y++;if(D.find("input[name='productTax']").length>0){var C=parseFloat(D.find("input[name='productTax']").val());var E=parseInt(D.find("input[name='quantity']").val());A+=(C*E)}});$("#footSelectItems i").html(y);if(A==0){$("#footCartTotalTax").hide()}else{$("#footCartTotalTax").show();if(A<=50){$("#footCartTotalTax i").html("￥"+A.toFixed(2)+"(免税)")}else{$("#footCartTotalTax i").html("￥"+A.toFixed(2))}$("#footCartTotalTax").show()}B=B-z;if(A<=50){$("#footCartProductPrice i").html("￥"+B.toFixed(2))}else{$("#footCartProductPrice i").html("￥"+(B+A).toFixed(2))}if(z>0){$("#footCartProductDiscount").html("商品优惠<i>￥"+(z).toFixed(2)+"</i>")}else{$("#footCartProductDiscount").html("")}}function t(z){var y=z.parents(".cart-list-size");y.find(".quer-btn").click(function(){var D=true;y.find(".dd").each(function(){if($(this).find(".selected").length==0){D=false}});if(!D){showMessageDiv("warn","请勾选您要的商品规格信息");return false}var C="";y.find(".selected").each(function(){C+="-"+$(this).attr("val")});var A=y.parents(".cart-list");var B=A.find("input[name='cartItemId']").val();$.ajax({type:"POST",dataType:"json",url:"editCartItemSpecification.jhtml?cartItemId="+B+"&specifics="+C.substring(1),success:function(I){if(I.type=="success"){A.find(".specificaDepict").val(I.content);A.find(".specifica").val(C.substring(1));var H=A.find(".specificaDepict").val();if(H!=""){var F=H.split("|");var G="";for(var E=0;E<F.length;E++){if(F[E]!=""){var J=F[E].split(":");G+=J[0]+"："+J[1]+"<br />"}}A.find(".specifica_show").html("").append(G)}}}});y.find("p").removeAttr("class");y.find(".arrow").hide();y.find(".cart-list-size-edits").hide()})}function v(z){var y=z.parents(".cart-list-size");y.find(".cancle-btn").click(function(){y.find("p").removeAttr("class");y.find(".arrow").hide();y.find(".cart-list-size-edits").hide()})}function m(A,z){var y=A.parents(".cart-list-size");var B=new Array();y.find(".cart-list-size-edits").find(".dd").each(function(F,I){var H=new Array();y.find(".cart-list-size-edits").find(".dd").each(function(K,J){if(F!=K&&$(J).find(".selected").length>0){H.push($(J).find(".selected").attr("val"))}});if(H.length>0){var C=new Array();for(var E=0;E<z.length;E++){var G=true;for(var D=0;D<H.length;D++){if(z[E].indexOf("-"+H[D]+"-")==-1){G=false;break}}if(G){C.push(z[E])}}$(I).find("a").addClass("locked");$(I).find("a").each(function(L,J){for(var K=0;K<C.length;K++){if(C[K].indexOf("-"+$(J).attr("val")+"-")>-1){$(J).removeClass("locked");break}}})}else{$(I).find("a").removeClass("locked")}})}function h(A,z){var y=A.parents(".cart-list-size");y.find(".dd a").click(function(){if(!$(this).hasClass("locked")){if($(this).hasClass("selected")){$(this).parent().find("a").addClass("text").removeClass("selected").find("i").remove();$(this).removeClass("selected").find("i").remove()}else{$(this).parent().find("a").addClass("text").removeClass("selected").find("i").remove();$(this).addClass("selected").removeClass("text").append("<i></i>")}m(A,z)}})}function b(){var A=$(this);$itemDiv=A.parents(".cart-list");var z="-"+$itemDiv.find(".specifica").val()+"-";var y=$itemDiv.find("input[name='productId']").val();$.ajax({type:"POST",dataType:"json",url:"getSpecification.jhtml?productId="+y,success:function(F){var B=JSON.stringify(F.groups).split(",");var E="";for(var D=0;D<F.productSpecification.length;D++){for(var C=0;C<F.productSpecification[D].length;C++){if(C==0){E+="<h2>"+F.productSpecification[D][C].specificationName+"：</h2>";E+='<div class="dd">'}if(z.indexOf("-"+F.productSpecification[D][C].id+"-")!=-1){E+='<a class="selected" href="javascript:void(0);" val="'+F.productSpecification[D][C].id+'">'+F.productSpecification[D][C].name+"<i></i></a>"}else{E+='<a class="text" href="javascript:void(0);" val="'+F.productSpecification[D][C].id+'">'+F.productSpecification[D][C].name+"</a>"}if(C==F.productSpecification[D].length-1){E+="</div>";E+='<div class="clear"></div>'}}}if(E!=""){E+='<div class="car_btn1-warp"> <a class="quer-btn" href="javascript:void(0);">确定</a> <a class="cancle-btn" href="javascript:void(0);">取消</a></div>';E+='<div class="clear"></div>';$itemDiv.find(".cart-list-size p").attr("class","active");$itemDiv.find(".arrow").show();$itemDiv.find(".cart-list-size-edits").html(E).show();h(A,B);m(A,B);v(A);t(A)}}})}function i(){$(".specificaDepict").each(function(B,D){if($(this).val()!=""){var z=$(this).val().split("|");var A="";for(var y=0;y<z.length;y++){if(z[y]!=""){var C=z[y].split(":");A+=C[0]+"："+C[1]+"<br />"}}$(this).parent().find(".specifica_show").append(A);$(this).parent().find(".specifica_edit").click(b)}else{$(this).parent().find(".cart-list-size p").empty().attr("class","noboder")}})}function u(y){var z=false;$.ajax({url:"checkCartItemSubmit.jhtml",type:"POST",dataType:"json",data:{cartItemIds:y},cache:false,async:false,success:function(A){if(A.type=="success"){z=true}else{showMessageDiv(A.type,A.content,"/cart/list.jhtml")}}});return z}function w(){$("input.cart-cart-btn").click(function(){var z=$("input[name='ids']:enabled:checked");if(z.length<=0){showMessageDiv("warn","至少选择一件商品");return false}if(!$.checkLogin()){$("#redirectURL").val("/cart/list.jhtml");$("#div_login_reg").show();return false}var y="";z.each(function(){if(y==""){y+=$(this).val()}else{y+=(","+$(this).val())}});if(!u(y)){return false}window.location.href="/member/order/info.jhtml"})}s.pageInit=function(){p=$(".selectMerchant");o=$(".selectAll");a=$("input[name='ids']");e();x();c();j();r();q();d();g();f();w();n();l();i();$("#floatDiv").bottomFloat({classAdd:"cart-total-hui",classRemove:"cart-total-huang"});$("#ddws_close").click(function(){$("#ddws_7t").hide()})}})(Sy.shop.cart);$(function(a){Sy.shop.cart.pageInit();ajaxRecentlyProduct("checkCart_recentlyViewedProduct",8)});